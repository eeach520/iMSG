{% extends "base.html" %}
{% block title %}iMESSAGE - messages{% endblock %}
{% block active3 %}
    class="active"
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="static/bootstrap-table-master/dist/bootstrap-table.css"/>
    <link rel="stylesheet" href="static/bootstrap3-dialog-master/dist/css/bootstrap-dialog.css"/>
    <link rel="stylesheet" href="static/x-editable-develop/dist/bootstrap3-editable/css/bootstrap-editable.css"/>
    {#        <link rel="stylesheet" href="static/bootstrap-editable/css/bootstrap-editable.css"/>#}
    <meta name="viewport" content="width=device-width">
{% endblock %}


{% block list %}
    <div class="container">
        <div class="panel-primary panel">
            {% if current_user.role_id==1 %}
                <div id="toolbar" class="btn-group">
                    <button id="btn_add" type="button" class="btn btn-primary" data-toggle="modal"
                            data-target="#myModals" onclick="reset()">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
                    </button>
                    <button id="btn_delete" type="button" class="btn btn-primary">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
                    </button>
                </div>
            {% endif %}
            <table id="mytab" class="table table-striped bg-warning"></table>
        </div>
    </div>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title" id="myModalLabel">修改信息</h4>
                </div>
                <div class="modal-body bg-warning">
                    <div class="container">
                        <div class="col-md-2 col-md-offset-2 btn-primary">
                            <h5><span class="glyphicon glyphicon-user"></span><i id="username">陌生人</i></h5>
                        </div>
                    </div>
                    <br>
                    <div class="container">
                        <br>
                        <div class="col-md-4 col-sm-offset-1">
                            每天发送频次：<input type="text" name="stuno" class="form-control" id="per_day"/>
                            <br>
                            每小时发送频次：<input type="text" name="pass" class="form-control" id="per_hour"/>
                            <br><br>
                            发送消息功能：<label>
                            <input type="checkbox" value="true" id="yes">开启
                        </label>
                        </div>
                        <br><br>
                    </div>
                </div>
                <div class="modal-footer bg-warning">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="update()">提交更改</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="myModals" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title" id="myModalLabel">添加用户</h4>
                </div>
                <div class="modal-body bg-warning">
                    <br>
                    <br>
                    <div class="container">
                        <br>
                        <div class="col-md-4 col-sm-offset-1">
                            用户名：<input class="form-control" type="text" name="sd" id="add_username">
                            <br>
                            密码：<input class="form-control" type="password" id="add_password">
                            <br>
                            确认密码：<input class="form-control" type="password" id="add_password2">
                            <br>
                            每天发送频次：<input type="text" name="stuno" class="form-control" id="add_per_day"/>
                            <br>
                            每小时发送频次：<input type="text" name="pass" class="form-control" id="add_per_hour"/>
                            <br><br>
                            发送消息功能：<label>
                            <input type="checkbox" value="true" id="add_yes">开启
                        </label>
                        </div>
                        <br><br>
                    </div>
                </div>
                <div class="modal-footer bg-warning">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="add_user()">添加用户</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block page_content %}
    <div class="page-header">
        <h1>Hello, {% if current_user.is_authenticated %}{{ current_user.username }}{% else %}Stranger{% endif %}!</h1>
    </div>
{% endblock %}



{% block js %}
    {#    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>#}
    {#    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>#}
    {#    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>#}
    {#   <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>#}
    {#    <script src="static/jqueryui-editable.js"></script>#}
    {#    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">#}
    {#    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>#}
    {#    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>#}
    {#    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">#}
    {#    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>#}
    {#    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>#}

    <!-- x-editable (bootstrap version) -->
    {#    <link href="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/css/bootstrap-editable.css"#}
    {#          rel="stylesheet"/>#}
    {#    <script src="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/js/bootstrap-editable.min.js"></script>#}
    <script src="static/bootstrap-editable/js/bootstrap-editable.js"></script>
    <script src="static/bootstrap-table-master/dist/bootstrap-table.js"></script>
    <script src="static/bootstrap-table-master/dist/locale/bootstrap-table-zh-CN.js"></script>
    <script src="static/knockout-3.4.2/dist/knockout.js"></script>
    <script src="static/bootstrap3-dialog-master/dist/js/bootstrap-dialog.js"></script>
    <script type="text/javascript">
        $(function () {
            $('#username').editable({
                type: 'text',
                pk: 1,
                url: '/delete',
                title: 'Enter username'
            });
            $('#heihei').on('click', function () {
                alert('asd')
            })
            $('#btn_delete').on('click', function () {
                var index = getIdSelections();
                if (index.length == 0) {
                    alert('至少选择一个用户')
                } else {
                    var r = confirm('你确定要删除用户' + index + '吗？', 'iMSG提示');
                    if (r) {
                        $.ajax({
                            url: '/delete',
                            type: 'POST',
                            data: JSON.stringify(getIdSelections()),
                            contentType: "application/json",
                            dataType: "json",
                            formatLoadingMessage: function () {
                                return "请稍等，正在加载中...";
                            },
                            success: function (data, status) {
                                if (data['success'] == 'OK') {
                                    $('#mytab').bootstrapTable('remove', {
                                        field: 'username',
                                        values: getIdSelections()
                                    });
                                    alert('删除成功')
                                } else {
                                    alert("删除失败" + data['error'])
                                }
                            },
                            error: function () {
                                alert("连接错误！")
                            }
                        })
                    } else {
                        alert('asd')
                    }
                }
            });
            $(window).resize(function () {
                $('#mytab').bootstrapTable('resetView', {
                    height: tableHeight()
                })
            });
            $('#mytab').bootstrapTable({
                url: '/userdata',
                dataField: "rows",
                {#                search: true,#}
                pagination: true,
                height: tableHeight(),
                editable: true,
                pageNumber: 1,
                search: true,
                pageSize: 20,
                pageList: [5, 10, 20, 50],
                sidePagination: "server",
                contentType: "application/json",
                dataType: "json",
                method: "post",
                searchAlign: "left",
                showToggle: true,
                striped: true,
                queryType: 'limit',
                queryParams: queryParams,
                searchOnEnterKey: "true",
                showRefresh: "true",
                showColumns: "true",
                buttonsAlign: "left",
                toolbar: "#toolbar",
                toolbarAlign: "right",
                sortsble: true,
                minimumCountColumns: 2,
                paginationPreText: "上一页",
                paginationNextText: "下一页",
                columns: [
                    {
                        title: "全选",
                        field: "select",
                        checkbox: true,
                        width: 20,//宽度
                        align: "center",//水平
                        valign: "middle"//垂直
                    },
                    {
                        title: "序号",//标题
                        field: "id",//键名
                        sortable: false,//是否可排序
                        order: "desc"//默认排序方式
                    },
                    {
                        field: "username",
                        title: "用户名",
                        align: 'center',
                        valign: 'middle',
                        sortable: true,
                        titleTooltip: "this is name"
                    },
                    {
                        field: "per_day",
                        title: "每天发送频次",
                        align: 'center',
                        valign: 'middle',
                        sortable: true
                    },
                    {
                        field: "per_hour",
                        title: "每小时发送频次",
                        align: 'center',
                        valign: 'middle',
                        sortable: true
                    },
                    {
                        field: "available",
                        title: "发送权限",
                        sortable: true,
                        align: 'center',
                        valign: 'middle'
                    },
                    {
                        field: "since",
                        title: "注册时间",
                        sortable: true,
                        align: 'center',
                        valign: 'middle'
                    },
                    {
                        field: "seen",
                        title: "最近活动时间",
                        sortable: true,
                        align: 'center',
                        valign: 'middle'
                    },
                    {
                        field: 'operates',
                        title: '历史',
                        align: 'center',
                        valign: 'middle',
                        formatter: function (value, row, index) {
                            var a = '<a href="/user?username=' + row.username + '"><span class="glyphicon glyphicon-hand-right"></span>  详情</a>';
                            return a;
                        }
                    },
                    {
                        field: 'operate',
                        title: '操作',
                        align: 'center',
                        valign: 'middle',
                        formatter: function (value, row, index) {
                            var e = '<button class="btn btn-primary detailBtn" data-toggle="modal" data-target="#myModal" onclick="hahaheihei(\'' + row.username + '\',\'' + row.per_day + '\',\'' + row.per_hour + '\',\'' + row.available + '\')"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> 编辑</button>';
                            return e;
                        }//自定义方法，添加操作按钮
                    }
                ],
                {#                onClickRow: function (row, $element) {#}
                {#                    //$element是当前tr的jquery对象#}
                {#                    $element.css("background-color", "orange");#}
                {#                },#}
                onEditableSave: function (field, row, oldValue, $el) {
                    alert('asd');
                    {#                    $.ajax({#}
                    {#                        type: "post",#}
                    {#                        url: "/Editable/Edit",#}
                    {#                        data: {strJson: JSON.stringify(row)},#}
                    {#                        success: function (data, status) {#}
                    {#                            if (status == "success") {#}
                    {#                                alert("编辑成功");#}
                    {#                            }#}
                    {#                        },#}
                    {#                        error: function () {#}
                    {#                            alert("Error");#}
                    {#                        },#}
                    {#                        complete: function () {#}
                    {##}
                    {#                        }#}
                    {#                    });#}
                },
                locale: "zh-CN"
            }).on('load-error.bs.table', function (e, status) {
                alert("似乎好像大约大概可能也许是网络出了一些问题吧");
            });
        });
        function tableHeight() {
            return $(window).height() - 50;
        }
        var queryParams = function (params) {
            var param = {
                pageIndex: Math.ceil(params.offset / params.limit) + 1,
                pageSize: params.limit,
                order: params.order,
                ordername: params.sort,
                searchText: params.search,
            };
            return param;
        };
        {#        var operateFormatter = function (value, row, index) {#}
        {#            return [#}
        {#                '<a href="http://www.sina.com"><button class="modbtn btn-info btn-sm rightSize detailBtn" type="button"><i class="fa fa-paste"></i> 编辑</button></a>',#}
        {#                '<button class="delete btn btn-danger btn-sm rightSize packageBtn" type="button" onclick="declick(this)"><i class="fa fa-envelope"></i> 删除</button>'#}
        {#            ].join('');#}
        {#        };#}
        function getIdSelections() {
            return $.map($("#mytab").bootstrapTable('getSelections'), function (row) {
                return row.username;
            });
        };
        function declick(deobject) {
            var de = $(deobject)
            alert(de.parent("tr").username)
            de.parents("tr").remove();
        };
        function hahaheihei(username, per_day, per_hour, available) {
            var a = username;
            var b = per_day;
            var c = per_hour;
            var d = available;
            document.getElementById("username").innerText = a;
            document.getElementById("per_day").value = b;
            document.getElementById("per_hour").value = c;
            if (d == 'true') {
                document.getElementById('yes').checked = true;
            } else {
                document.getElementById('yes').checked = false;
            }
        };
        function update() {
            var username = document.getElementById("username").innerText;
            var per_day = document.getElementById("per_day").value;
            var per_hour = document.getElementById("per_hour").value;
            var sex = document.getElementById("yes").checked;
            $.ajax({
                type: "post",
                url: "/modify",
                data: JSON.stringify([username, per_day, per_hour, sex]),
                dataType: 'json',
                contentType: "application/json",
                success: function (data, status) {
                    var a = data['success']
                    if (a == 'OK') {
                        alert('修改成功');
                        $("#myModal").dialog('close');
                    } else {
                        alert('修改失败' + data['error'])
                    }
                }
            });
        };
        function add_user() {
            var username = document.getElementById("add_username").value;
            var password = document.getElementById('add_password').value;
            var password2 = document.getElementById('add_password2').value;
            var per_day = document.getElementById("add_per_day").value;
            var per_hour = document.getElementById("add_per_hour").value;
            var sex = document.getElementById("add_yes").checked;
            if (password == password2) {
                $.ajax({
                    type: "post",
                    url: "/add",
                    data: JSON.stringify([username, password, per_day, per_hour, sex]),
                    dataType: 'json',
                    contentType: "application/json",
                    success: function (data, status) {
                        var a = data['success']
                        if (a == 'OK') {
                            alert('添加成功');
                            $("#myModals").dialog('close');
                        } else {
                            alert('添加失败，' + data['error'])
                        }
                    }
                });
            } else {
                alert('密码必须一致')
            }
        }
        function reset() {
            document.getElementById("add_username").value='';
            document.getElementById('add_password').value='';
            document.getElementById('add_password2').value='';
            document.getElementById("add_per_day").value='';
            document.getElementById("add_per_hour").value='';
        }
    </script>
{% endblock %}